<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025 Â· å¹´åº¦è®°å½•</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>

  <!-- <header>
    <h1>2025</h1>
    <p>è¿™ä¸€å¹´çš„å…³é”®è¯ï¼šæ²‰æ·€ã€æ¢ç´¢ã€ç”Ÿé•¿</p>
  </header> -->
  <header style="display: flex; align-items: center; gap: 20px;">
    <div id="music-trigger" class="snake-icon">
      ğŸ </div>
  
    <div>
      <h1>2025</h1>
      <p>è¿™ä¸€å¹´çš„å…³é”®è¯ï¼šæ²‰æ·€ã€æ¢ç´¢ã€ç”Ÿé•¿</p>
    </div>
    
    <audio id="bgm" src="assets/summerwar.mp3" loop></audio>
  </header>
  
  <main>
    <section>
      <h2>å¹´åº¦å›é¡¾</h2>
      <p>è¿™ä¸€å¹´å‘ç”Ÿäº†å¾ˆå¤šé‡è¦çš„äº‹æƒ…ï¼Œæˆ‘ä»¬è§è¯äº†æŠ€æœ¯çš„å˜é©ï¼Œä¹Ÿç•™ä¸‹äº†ç”Ÿæ´»çš„ç—•è¿¹ã€‚</p>
    </section>

    <section>
      <h2>å½±åƒè®°å¿†</h2>
      <img src="assets/media/image.jpg" alt="å¹´åº¦ç…§ç‰‡">
    </section>

    <section id="comments">
      <h2>ç•™è¨€äº’åŠ¨</h2>
      <form id="comment-form">
        <input id="name" placeholder="ä½ çš„æ˜µç§°" required />
        <textarea id="content" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." rows="4" required></textarea>
        <button type="submit">å‘å¸ƒç•™è¨€</button>
      </form>

      <div id="comment-list">
        </div>
    </section>
  </main>

  <script>
    const PAGE = "2025";
    const commentList = document.getElementById("comment-list");
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#A29BFE'];
    const bgm = document.getElementById('bgm');
    const musicTrigger = document.getElementById('music-trigger');

    function formatTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = (now - date) / 1000;
    
      if (diff < 60) return 'åˆšåˆš';
      if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
      if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
      
      return date.toLocaleString('zh-CN', { 
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
    function playMusic() {
        bgm.play().then(() => {
            musicTrigger.classList.add('playing');
        }).catch(err => {
            console.log("æ’­æ”¾è¢«æ‹¦æˆª:", err);
        });
    }
    
    function pauseMusic() {
        bgm.pause();
        musicTrigger.classList.remove('playing');
    }
    
    // 1. è›‡å›¾æ ‡çš„ç‚¹å‡»ï¼šæ‰‹åŠ¨åˆ‡æ¢å¼€å…³
    musicTrigger.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜²æ­¢è§¦å‘ä¸‹é¢çš„å…¨å±€ç‚¹å‡»äº‹ä»¶
        if (bgm.paused) {
            playMusic();
        } else {
            pauseMusic();
        }
    });
    
    // 2. å…¨å±€ç‚¹å‡»ï¼šåªè¦è¿˜æ²¡æ’­ï¼Œç‚¹å“ªé‡Œéƒ½å°è¯•è§¦å‘
    document.addEventListener('click', () => {
        if (bgm.paused) {
            playMusic();
        }
    }, { once: true }); // { once: true } ä¿è¯è¿™ä¸ªå…¨å±€ç›‘å¬å™¨åªåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ç”Ÿæ•ˆ
    
    // 3. é’ˆå¯¹ç§»åŠ¨ç«¯ï¼ˆå¦‚å¾®ä¿¡ã€Safariï¼‰çš„è§¦æ‘¸è§¦å‘
    document.addEventListener('touchstart', () => {
        if (bgm.paused) {
            playMusic();
        }
    }, { once: true });
    
    // 4. è¾…åŠ©ï¼šç›‘å¬éŸ³é¢‘çŠ¶æ€åŒæ­¥å›¾æ ‡
    bgm.onplay = () => musicTrigger.classList.add('playing');
    bgm.onpause = () => musicTrigger.classList.remove('playing');

    // åŠ è½½ç•™è¨€
    /***********************
     * å¤šçº§åµŒå¥—è¯„è®ºç³»ç»Ÿ
     ***********************/
    
    // å½“å‰å›å¤çš„çˆ¶è¯„è®º ID
    let currentParentId = null;
    
    /**
     * å°†æ‰å¹³ comments è½¬æˆæ ‘ç»“æ„
     */
    function buildCommentTree(comments) {
      const map = {};
      const roots = [];
    
      comments.forEach(c => {
        map[c.id] = { ...c, children: [] };
      });
    
      comments.forEach(c => {
        if (c.parent_id) {
          const parent = map[c.parent_id];
          if (parent) {
            parent.children.push(map[c.id]);
          }
        } else {
          roots.push(map[c.id]);
        }
      });
    
      return roots;
    }
    
    /**
     * é€’å½’æ¸²æŸ“å•æ¡è¯„è®º
     */
    function renderComment(comment, level = 0) {
      const bgColor = colors[comment.name.length % colors.length];
      const firstChar = comment.name.charAt(0).toUpperCase();
      const indent = level * 24;
    
      return `
        <div class="comment-item" style="margin-left:${indent}px">
          <div class="comment-avatar" style="background:${bgColor}">
            ${firstChar}
          </div>
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-name">${comment.name}</span>
              <span class="comment-time">${formatTime(comment.created_at)}</span>
            </div>
            <div class="comment-body">${comment.content}</div>
            <div class="comment-actions">
              <button onclick="replyTo(${comment.id}, '${comment.name}')">å›å¤</button>
            </div>
          </div>
        </div>
        ${comment.children.map(child => renderComment(child, level + 1)).join('')}
      `;
    }
    
    /**
     * åŠ è½½ç•™è¨€
     */
    async function loadComments() {
      try {
        const res = await fetch(`/api/comment?page=${PAGE}`);
        const comments = await res.json();
    
        if (!comments || comments.length === 0) {
          commentList.innerHTML =
            '<p style="text-align:center;color:#ccc;margin-top:20px;">æš‚æ— ç•™è¨€</p>';
          return;
        }
    
        const tree = buildCommentTree(comments);
    
        commentList.innerHTML = tree
          .map(root => renderComment(root))
          .join('');
    
      } catch (err) {
        console.error(err);
        commentList.innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥</p>';
      }
    }
    
    /**
     * å›å¤æŸæ¡è¯„è®º
     */
    function replyTo(parentId, username) {
      currentParentId = parentId;
      const textarea = document.getElementById("content");
      textarea.value = `@${username} `;
      textarea.focus();
    }
    
    /**
     * æäº¤ç•™è¨€
     */
    document.getElementById("comment-form").onsubmit = async (e) => {
      e.preventDefault();
    
      const nameInput = document.getElementById("name");
      const contentInput = document.getElementById("content");
      const btn = e.target.querySelector("button");
    
      btn.disabled = true;
      btn.innerText = "å‘é€ä¸­...";
    
      try {
        await fetch("/api/comment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            page: PAGE,
            name: nameInput.value,
            content: contentInput.value,
            parent_id: currentParentId   // â­ å…³é”®
          })
        });
    
        contentInput.value = "";
        currentParentId = null;
    
        await loadComments();
      } catch (err) {
        alert("å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
      } finally {
        btn.disabled = false;
        btn.innerText = "å‘å¸ƒç•™è¨€";
      }
    };
    
    // åˆå§‹åŠ è½½
    loadComments();

  </script>
</body>
  
<footer>
  <a href="2024.html">â† 2024</a> |
  <a href="index.html">è¿”å›é¦–é¡µ</a> |
  
</footer>
  
</html>
