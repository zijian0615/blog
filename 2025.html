<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025 Â· å¹´åº¦è®°å½•</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>

  <!-- <header>
    <h1>2025</h1>
    <p>è¿™ä¸€å¹´çš„å…³é”®è¯ï¼šæ²‰æ·€ã€æ¢ç´¢ã€ç”Ÿé•¿</p>
  </header> -->
  <header style="display: flex; align-items: center; gap: 20px;">
    <div id="music-trigger" class="snake-icon">
      ğŸ </div>
  
    <div>
      <h1>2025</h1>
      <p>è¿™ä¸€å¹´çš„å…³é”®è¯ï¼šæ²‰æ·€ã€æ¢ç´¢ã€ç”Ÿé•¿</p>
    </div>
    
    <audio id="bgm" src="assets/summerwar.mp3" loop></audio>
  </header>
  
  <main>
    <section>
      <h2>å¹´åº¦å›é¡¾</h2>
      <p>è¿™ä¸€å¹´å‘ç”Ÿäº†å¾ˆå¤šé‡è¦çš„äº‹æƒ…ï¼Œæˆ‘ä»¬è§è¯äº†æŠ€æœ¯çš„å˜é©ï¼Œä¹Ÿç•™ä¸‹äº†ç”Ÿæ´»çš„ç—•è¿¹ã€‚</p>
    </section>

    <section>
      <h2>å½±åƒè®°å¿†</h2>
      <img src="assets/media/image.jpg" alt="å¹´åº¦ç…§ç‰‡">
    </section>

    <section id="comments">
      <h2>ç•™è¨€äº’åŠ¨</h2>
      <form id="comment-form">
        <input id="name" placeholder="ä½ çš„æ˜µç§°" required />
        <textarea id="content" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." rows="4" required></textarea>
        <button type="submit">å‘å¸ƒç•™è¨€</button>
      </form>

      <div id="comment-list">
        </div>
    </section>
  </main>

  <script>
    const PAGE = "2025";
    const commentList = document.getElementById("comment-list");
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#A29BFE'];
    const bgm = document.getElementById('bgm');
    const musicTrigger = document.getElementById('music-trigger');
    
    // ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
    function playMusic() {
        bgm.play().then(() => {
            musicTrigger.classList.add('playing');
        }).catch(err => {
            console.log("æ’­æ”¾è¢«æ‹¦æˆª:", err);
        });
    }
    
    function pauseMusic() {
        bgm.pause();
        musicTrigger.classList.remove('playing');
    }
    
    // 1. è›‡å›¾æ ‡çš„ç‚¹å‡»ï¼šæ‰‹åŠ¨åˆ‡æ¢å¼€å…³
    musicTrigger.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜²æ­¢è§¦å‘ä¸‹é¢çš„å…¨å±€ç‚¹å‡»äº‹ä»¶
        if (bgm.paused) {
            playMusic();
        } else {
            pauseMusic();
        }
    });
    
    // 2. å…¨å±€ç‚¹å‡»ï¼šåªè¦è¿˜æ²¡æ’­ï¼Œç‚¹å“ªé‡Œéƒ½å°è¯•è§¦å‘
    document.addEventListener('click', () => {
        if (bgm.paused) {
            playMusic();
        }
    }, { once: true }); // { once: true } ä¿è¯è¿™ä¸ªå…¨å±€ç›‘å¬å™¨åªåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ç”Ÿæ•ˆ
    
    // 3. é’ˆå¯¹ç§»åŠ¨ç«¯ï¼ˆå¦‚å¾®ä¿¡ã€Safariï¼‰çš„è§¦æ‘¸è§¦å‘
    document.addEventListener('touchstart', () => {
        if (bgm.paused) {
            playMusic();
        }
    }, { once: true });
    
    // 4. è¾…åŠ©ï¼šç›‘å¬éŸ³é¢‘çŠ¶æ€åŒæ­¥å›¾æ ‡
    bgm.onplay = () => musicTrigger.classList.add('playing');
    bgm.onpause = () => musicTrigger.classList.remove('playing');

    // åŠ è½½ç•™è¨€
    async function loadComments() {
      try {
        const res = await fetch(`/api/comment?page=${PAGE}`);
        const comments = await res.json();
        
        if (!comments || comments.length === 0) {
          commentList.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">æš‚æ— ç•™è¨€</p>';
          return;
        }
    
        // --- æ’åºç®—æ³•å¼€å§‹ ---
        let thread = []; // å­˜å‚¨æœ€ç»ˆæ’åºåçš„æ•°ç»„
        let mainComments = comments.filter(c => !c.content.trim().startsWith('@'));
        let replies = comments.filter(c => c.content.trim().startsWith('@'));
    
        mainComments.forEach(main => {
          thread.push(main); // å…ˆæ”¾ä¸»ç•™è¨€
          // å¯»æ‰¾æ‰€æœ‰å›å¤è¿™æ¡ä¸»ç•™è¨€çš„è¯„è®ºï¼ˆé€šè¿‡æ£€æŸ¥å†…å®¹é‡Œæ˜¯å¦åŒ…å« @ç”¨æˆ·åï¼‰
          let relatedReplies = replies.filter(r => r.content.includes(`@${main.name}`));
          thread.push(...relatedReplies); // æŠŠå±äºå®ƒçš„å›å¤ç´§è·Ÿå…¶å
        });
    
        // å¤„ç†é‚£äº›å¯èƒ½æ²¡åŒ¹é…ä¸Šçš„å­¤å„¿å›å¤ï¼ˆå¯é€‰ï¼‰
        replies.forEach(r => {
            if (!thread.includes(r)) thread.push(r);
        });
        // --- æ’åºç®—æ³•ç»“æŸ ---
    
        commentList.innerHTML = thread.map(c => {
          const isReply = c.content.trim().startsWith('@');
          const bgColor = colors[c.name.length % colors.length];
          const firstChar = c.name.charAt(0).toUpperCase();
          
          return `
            <div class="comment-item ${isReply ? 'reply-item' : ''}">
              <div class="comment-avatar" style="background: ${bgColor}">${firstChar}</div>
              <div class="comment-content">
                <div class="comment-header">
                  <span class="comment-name">${c.name} ${isReply ? '<small class="reply-tag">å›å¤</small>' : ''}</span>
                  <span class="comment-time">${formatTime(c.created_at)}</span>
                </div>
                <div class="comment-body">${c.content}</div>
                <div class="comment-actions">
                  <button onclick="replyTo('${c.name}')">å›å¤</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error(err);
        commentList.innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥</p>';
      }
    }

    // å›å¤å¿«æ·æ“ä½œ
    function replyTo(username) {
      const textarea = document.getElementById("content");
      textarea.value = `@${username} `;
      textarea.focus();
    }

    // æäº¤ç•™è¨€
    document.getElementById("comment-form").onsubmit = async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById("name");
      const contentInput = document.getElementById("content");
      const btn = e.target.querySelector('button');

      btn.disabled = true;
      btn.innerText = 'å‘é€ä¸­...';

      try {
        await fetch('/api/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            page: PAGE, 
            name: nameInput.value, 
            content: contentInput.value 
          })
        });
        contentInput.value = '';
        await loadComments();
      } catch (err) {
        alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
      } finally {
        btn.disabled = false;
        btn.innerText = 'å‘å¸ƒç•™è¨€';
      }
    }

    // åˆå§‹åŠ è½½
    loadComments();
  </script>
</body>
  
<footer>
  <a href="2024.html">â† 2024</a> |
  <a href="index.html">è¿”å›é¦–é¡µ</a> |
  
</footer>
  
</html>
