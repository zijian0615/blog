<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025 Â· å¹´åº¦è®°å½•</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>

  <!-- <header>
    <h1>2025</h1>
    <p>è¿™ä¸€å¹´çš„å…³é”®è¯ï¼šæ²‰æ·€ã€æ¢ç´¢ã€ç”Ÿé•¿</p>
  </header> -->
  <header style="display: flex; align-items: center; gap: 20px;">
    <div id="music-trigger" class="snake-icon">
      ğŸ </div>
  
    <div>
      <h1>2025</h1>
      <p>è¿™ä¸€å¹´çš„å…³é”®è¯ï¼šæ²‰æ·€ã€æ¢ç´¢ã€ç”Ÿé•¿</p>
    </div>
    
    <audio id="bgm" src="assets/summerwar.mp3" loop></audio>
  </header>
  
  <main>
    <section>
      <h2>å¹´åº¦å›é¡¾</h2>
      <p>è¿™ä¸€å¹´å‘ç”Ÿäº†å¾ˆå¤šé‡è¦çš„äº‹æƒ…ï¼Œæˆ‘ä»¬è§è¯äº†æŠ€æœ¯çš„å˜é©ï¼Œä¹Ÿç•™ä¸‹äº†ç”Ÿæ´»çš„ç—•è¿¹ã€‚</p>
    </section>

    <section>
      <h2>å½±åƒè®°å¿†</h2>
      <img src="assets/media/image.jpg" alt="å¹´åº¦ç…§ç‰‡">
    </section>

    <section id="comments">
      <h2>ç•™è¨€äº’åŠ¨</h2>
      <form id="comment-form">
        <input id="name" placeholder="ä½ çš„æ˜µç§°" required />
        <textarea id="content" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." rows="4" required></textarea>
        <button type="submit">å‘å¸ƒç•™è¨€</button>
      </form>

      <div id="comment-list">
        </div>
    </section>
  </main>

  <script>
    const PAGE = "2025";
    const commentList = document.getElementById("comment-list");
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#A29BFE'];
    const bgm = document.getElementById('bgm');
    const musicTrigger = document.getElementById('music-trigger');

    function formatTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = (now - date) / 1000;
    
      if (diff < 60) return 'åˆšåˆš';
      if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
      if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
      
      return date.toLocaleString('zh-CN', { 
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
    function playMusic() {
        bgm.play().then(() => {
            musicTrigger.classList.add('playing');
        }).catch(err => {
            console.log("æ’­æ”¾è¢«æ‹¦æˆª:", err);
        });
    }
    
    function pauseMusic() {
        bgm.pause();
        musicTrigger.classList.remove('playing');
    }
    
    // 1. è›‡å›¾æ ‡çš„ç‚¹å‡»ï¼šæ‰‹åŠ¨åˆ‡æ¢å¼€å…³
    musicTrigger.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜²æ­¢è§¦å‘ä¸‹é¢çš„å…¨å±€ç‚¹å‡»äº‹ä»¶
        if (bgm.paused) {
            playMusic();
        } else {
            pauseMusic();
        }
    });
    
    // 2. å…¨å±€ç‚¹å‡»ï¼šåªè¦è¿˜æ²¡æ’­ï¼Œç‚¹å“ªé‡Œéƒ½å°è¯•è§¦å‘
    document.addEventListener('click', () => {
        if (bgm.paused) {
            playMusic();
        }
    }, { once: true }); // { once: true } ä¿è¯è¿™ä¸ªå…¨å±€ç›‘å¬å™¨åªåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ç”Ÿæ•ˆ
    
    // 3. é’ˆå¯¹ç§»åŠ¨ç«¯ï¼ˆå¦‚å¾®ä¿¡ã€Safariï¼‰çš„è§¦æ‘¸è§¦å‘
    document.addEventListener('touchstart', () => {
        if (bgm.paused) {
            playMusic();
        }
    }, { once: true });
    
    // 4. è¾…åŠ©ï¼šç›‘å¬éŸ³é¢‘çŠ¶æ€åŒæ­¥å›¾æ ‡
    bgm.onplay = () => musicTrigger.classList.add('playing');
    bgm.onpause = () => musicTrigger.classList.remove('playing');

     /***********************
     * å¤šçº§åµŒå¥—è¯„è®ºç³»ç»Ÿ
     ***********************/
    
    // å½“å‰å›å¤çš„çˆ¶è¯„è®º ID
    let currentReplyBox = null;
    
    // å°†æ‰å¹³ comments è½¬æˆæ ‘ç»“æ„
    function buildCommentTree(comments) {
      const map = {};
      const roots = [];
    
      comments.forEach(c => {
        map[c.id] = { ...c, children: [] };
      });
    
      comments.forEach(c => {
        if (c.parent_id) {
          const parent = map[c.parent_id];
          if (parent) {
            parent.children.push(map[c.id]);
          } else {
            roots.push(map[c.id]); // é˜²æ­¢çˆ¶è¯„è®ºä¸å­˜åœ¨
          }
        } else {
          roots.push(map[c.id]);
        }
      });
    
      return roots;
    }
    
    // æ¸²æŸ“å•æ¡è¯„è®º
    function renderComment(comment, level = 0) {
      const bgColor = colors[comment.name.length % colors.length];
      const firstChar = comment.name.charAt(0).toUpperCase();
      const indent = level * 24;
    
      const isFolded = level >= 3; // è¶…è¿‡ 3 å±‚é»˜è®¤æŠ˜å 
      const foldedClass = isFolded ? 'folded' : '';
      const toggleBtn = isFolded ? `<div class="toggle-children" onclick="toggleFold(this)">å±•å¼€å›å¤</div>` : '';
    
      return `
        <div class="comment-item ${foldedClass}" style="margin-left:${indent}px">
          <div class="comment-avatar" style="background:${bgColor}">${firstChar}</div>
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-name">${comment.name}</span>
              <span class="comment-time">${formatTime(comment.created_at)}</span>
            </div>
            <div class="comment-body">${comment.content}</div>
            <div class="comment-actions">
              <button onclick="showInlineReply(${comment.id}, this)">å›å¤</button>
            </div>
            ${toggleBtn}
            <div class="comment-children">
              ${comment.children.map(child => renderComment(child, level + 1)).join('')}
            </div>
        </div>
      `;
    }
    
    // åˆ‡æ¢æŠ˜å 
    function toggleFold(toggleElement) {
      const commentItem = toggleElement.closest('.comment-item');
      commentItem.classList.toggle('folded');
      toggleElement.innerText = commentItem.classList.contains('folded') ? 'å±•å¼€å›å¤' : 'æ”¶èµ·å›å¤';
    }
    
    // æ˜¾ç¤º inline å›å¤æ¡†
    function showInlineReply(parentId, btn) {
      if (currentReplyBox) {
        currentReplyBox.remove();
        currentReplyBox = null;
      }
    
      const div = document.createElement('div');
      div.className = 'inline-reply-box';
      div.innerHTML = `
        <textarea rows="3" placeholder="å›å¤..."></textarea>
        <button>å‘é€</button>
        <button type="button" onclick="cancelInlineReply(this)">å–æ¶ˆ</button>
      `;
    
      btn.closest('.comment-content').appendChild(div);
      currentReplyBox = div;
    
      const sendBtn = div.querySelector('button');
      const textarea = div.querySelector('textarea');
    
      sendBtn.onclick = async () => {
        const content = textarea.value.trim();
        if (!content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
    
        sendBtn.disabled = true;
        sendBtn.innerText = 'å‘é€ä¸­...';
    
        try {
          await fetch('/api/comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              page: PAGE,
              name: document.getElementById('name').value || 'åŒ¿å',
              content,
              parent_id: parentId
            })
          });
          currentReplyBox.remove();
          currentReplyBox = null;
          await loadComments();
        } catch (err) {
          alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        }
      };
    }
    
    // å–æ¶ˆ inline å›å¤
    function cancelInlineReply(btn) {
      btn.closest('.inline-reply-box').remove();
      currentReplyBox = null;
    }
    
    // åŠ è½½ç•™è¨€
    async function loadComments() {
      try {
        const res = await fetch(`/api/comment?page=${PAGE}`);
        const comments = await res.json();
    
        if (!comments || comments.length === 0) {
          commentList.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">æš‚æ— ç•™è¨€</p>';
          return;
        }
    
        const tree = buildCommentTree(comments);
        commentList.innerHTML = tree.map(c => renderComment(c)).join('');
      } catch (err) {
        console.error(err);
        commentList.innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥</p>';
      }
    }
    
    // åˆå§‹åŒ–åŠ è½½
    loadComments();

</body>
  
<footer>
  <a href="2024.html">â† 2024</a> |
  <a href="index.html">è¿”å›é¦–é¡µ</a> |
  
</footer>
  
</html>
